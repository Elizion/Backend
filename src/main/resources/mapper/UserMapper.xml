<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.core.backend.mapper.UserMapper">

    <select id="getDateNow" resultType="java.util.Date">
        SELECT NOW()
    </select>
       
	<select id="findByUsername" resultType="java.lang.String">
		SELECT  
			username
		FROM sistema_db.user
        WHERE username = #{username} 
    </select>
    
	<insert id="createdUser" parameterType="UserModel" useGeneratedKeys="true" keyProperty="userModel.idUser" keyColumn="id_user">
	    INSERT INTO sistema_db.user(
	    	username,
	    	password,
	    	email,
	    	enabled,
	    	created_at, 
	    	updated_at) 
	    VALUES (
	    	#{userModel.username},
	    	#{userModel.password},
	    	#{userModel.email},
	    	#{userModel.enabled}, 
	    	NOW(), 
	    	NOW())
	</insert>
	
	<insert id="createdUserImage">
	    INSERT INTO sistema_db.user_picture(
	    	id_user,
	    	picture) 
	    VALUES (
	    	#{idUser},
	    	#{b64})
	</insert>
	
	<insert id="createdUserRoles" parameterType="java.util.Set">
	    INSERT INTO sistema_db.user_role (
	    id_user,
	    id_role)
	    VALUES
	    <foreach collection="userModel.roles" item="role" index="index" open="(" separator="),("  close=")">
			#{userModel.idUser},
	        #{role.idRole}
	    </foreach>
	</insert>
    
	<resultMap id="findByUsernameAuthResult" type="com.core.backend.model.UserModel">
	  	<id 	property="idUser" 		column="id_user" />
	</resultMap>

	<select id="findByUsernameAuth" resultMap="findByUsernameAuthResult">
        SELECT 
        	id_user
        FROM sistema_db.user
		WHERE username = #{username}
		AND enabled = 1
    </select>
    
</mapper>